<!-- room.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Комната WatchParty</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <header>
    <button id="backBtn">На главную</button>
    <div id="roomInfo">
      <!-- Информация о комнате (название, хост и т.п.) -->
    </div>
    <div id="userControls">
      <!-- Если пользователь — хост, здесь появятся кнопки для настройки, удаления и переключения видео -->
    </div>
  </header>
  <main>
    <!-- Контейнер для плеера YouTube -->
    <div id="player"></div>

    <!-- Элементы управления плеером -->
    <div id="controls">
      <button id="playBtn">Воспроизвести</button>
      <button id="pauseBtn">Пауза</button>
      <button id="rewindBtn">Перемотать</button>
    </div>

    <!-- Кнопка для предложения видео -->
    <button id="proposeVideoBtn">Предложить видео</button>

    <!-- Очередь видео -->
    <div id="queue">
      <h2>Очередь видео</h2>
      <ul id="queueList"></ul>
    </div>
  </main>

  <!-- Модальное окно для предложения видео -->
  <div id="videoModal" class="modal">
    <div class="modal-content">
      <span class="close" id="closeVideoModal">&times;</span>
      <h2>Предложить видео</h2>
      <form id="videoForm">
        <input type="text" name="videoUrl" placeholder="Ссылка на видео (YouTube)" required>
        <button type="submit">Добавить в очередь</button>
      </form>
    </div>
  </div>

  <!-- Модальное окно для конфигурации комнаты -->
  <div id="configModal" class="modal">
    <div class="modal-content">
      <span class="close" id="closeConfigModal">&times;</span>
      <h2>Настройки комнаты</h2>
      <form id="configForm">
        <label>
          Название комнаты:
          <input type="text" name="name" id="roomNameInput" required>
        </label>
        <br>
        <label>
          Автоматический переход на следующее видео:
          <input type="checkbox" name="autoNext" id="autoNextCheckbox">
        </label>
        <br>
        <label>
          Любой участник может управлять плеером:
          <input type="checkbox" name="allowAllControl" id="allowAllControlCheckbox">
        </label>
        <br>
        <button type="submit">Сохранить настройки</button>
      </form>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script src="https://www.youtube.com/iframe_api"></script>
  <script>
    // ==================== ПАРАМЕТРЫ СИНХРОНИЗАЦИИ ====================
    // Флаг для предотвращения циклической отправки событий (при удалённой синхронизации)
    let isRemoteSync = false;

    // Для отслеживания seek (перемотки) – буфер времени
    let previousTime = 0;
    const SEEK_THRESHOLD = 3; // порог в секундах для определения перемотки

    // Для отслеживания play/pause – будем хранить предыдущее состояние плеера
    // Состояния: PLAYING = 1, PAUSED = 2 (по спецификации YouTube IFrame API)
    let previousPlayerState = null;
    // Интервал для опроса состояния плеера (в миллисекундах)
    const STATE_CHECK_INTERVAL = 500;

    // ==================== ФУНКЦИЯ ОТСЛЕЖИВАНИЯ PLAY/PAUSE (локально) ====================
    function checkLocalPlayerState() {
      if (player && typeof player.getPlayerState === 'function') {
        const currentState = player.getPlayerState(); // 1 = PLAYING, 2 = PAUSED, и т.д.
        // Если еще не задано предыдущее состояние – сохраняем и выходим
        if (previousPlayerState === null) {
          previousPlayerState = currentState;
          return;
        }
        // Если состояние изменилось (только для PLAYING и PAUSED)
        if ((currentState === 1 || currentState === 2) && currentState !== previousPlayerState) {
          console.log(`Local state change detected: from ${previousPlayerState} to ${currentState}`);
          // Отправляем событие синхронизации
          const action = (currentState === 1) ? 'play' : 'pause';
          socket.emit('playerAction', { roomId, action, timestamp: player.getCurrentTime() });
          previousPlayerState = currentState;
        }
      }
    }
    setInterval(checkLocalPlayerState, STATE_CHECK_INTERVAL);

    // ==================== ФУНКЦИЯ ОТСЛЕЖИВАНИЯ SEEK (перемотки) ====================
    function checkSeek() {
      if (player && typeof player.getCurrentTime === 'function') {
        const currentTime = player.getCurrentTime();
        if (previousTime !== 0 && Math.abs(currentTime - previousTime) > SEEK_THRESHOLD) {
          console.log(`Seek detected locally: Prev ${previousTime}, Current ${currentTime}`);
          socket.emit('playerAction', { roomId, action: 'seek', timestamp: currentTime });
        }
        previousTime = currentTime;
      }
    }
    setInterval(checkSeek, 1000); // проверка раз в секунду

    // ==================== ИЗВЛЕЧЕНИЕ roomId ====================
    const urlParams = new URLSearchParams(window.location.search);
    const roomId = urlParams.get('roomId');

    // ==================== ИНИЦИАЛИЗАЦИЯ SOCKET.IO ====================
    const socket = io();
    socket.emit('joinRoom', roomId);
    socket.on('userJoined', (data) => {
      console.log(`Пользователь ${data.socketId} присоединился`);
    });

    // ==================== ОБРАБОТКА СОБЫТИЯ СИНХРОНИЗАЦИИ ОТ СЕРВЕРА ====================
    socket.on('syncPlayer', (data) => {
      if (player && typeof player.seekTo === 'function') {
        isRemoteSync = true;  // устанавливаем флаг, чтобы onPlayerStateChange не отправлял событие
        if (data.action === 'play') {
          player.seekTo(data.timestamp, true);
          player.playVideo();
        } else if (data.action === 'pause') {
          player.seekTo(data.timestamp, true);
          player.pauseVideo();
        } else if (data.action === 'rewind' || data.action === 'seek') {
          player.seekTo(data.timestamp, true);
        }
        // Флаг будет сброшен в onPlayerStateChange
      }
    });

    socket.on('videoChanged', (data) => {
      if (data && data.videoId) {
        let videoId = data.videoId;
        if (videoId.includes('youtube.com')) {
          try {
            const urlObj = new URL(videoId);
            videoId = urlObj.searchParams.get('v') || videoId;
          } catch (e) {
            console.error('Ошибка при разборе URL', e);
          }
        }
        player.loadVideoById(videoId);
      } else {
        player.stopVideo();
      }
    });

    // ==================== ИНИЦИАЛИЗАЦИЯ YOUTUBE PЛЕЕРА ====================
    let player;
    function onYouTubeIframeAPIReady() {
      if (player && typeof player.destroy === 'function') {
        player.destroy();
        document.getElementById('player').innerHTML = '';
      }
      player = new YT.Player('player', {
        height: '390',
        width: '640',
        videoId: 'dQw4w9WgXcQ', // дефолтное видео (RickRoll)
        events: {
          'onReady': onPlayerReady,
          'onStateChange': onPlayerStateChange
        }
      });
      window.onYouTubeIframeAPIReady = onYouTubeIframeAPIReady;
    }
    window.onYouTubeIframeAPIReady = onYouTubeIframeAPIReady;

    function onPlayerReady(event) {
      // Если для комнаты задано текущее видео (установлено через loadRoomInfo), переключаем плеер
      if (window.currentRoomVideoId) {
        player.loadVideoById(window.currentRoomVideoId);
      }
      // Автозапуск видео (если браузер не блокирует)
      player.playVideo();
      
      // Привязываем обработчики кастомных кнопок управления
      document.getElementById('playBtn').addEventListener('click', () => {
        player.playVideo();
        socket.emit('playerAction', { roomId, action: 'play', timestamp: player.getCurrentTime() });
      });
      document.getElementById('pauseBtn').addEventListener('click', () => {
        player.pauseVideo();
        socket.emit('playerAction', { roomId, action: 'pause', timestamp: player.getCurrentTime() });
      });
      document.getElementById('rewindBtn').addEventListener('click', () => {
        const newTime = Math.max(player.getCurrentTime() - 10, 0);
        player.seekTo(newTime, true);
        socket.emit('playerAction', { roomId, action: 'rewind', timestamp: newTime });
      });
    }

    // Обработка изменения состояния плеера через onStateChange
    function onPlayerStateChange(event) {
      // Если это изменение вызвано удалённой синхронизацией, сбрасываем флаг и выходим
      if (isRemoteSync) {
        isRemoteSync = false;
        return;
      }
      // Мы больше не отправляем события play/pause здесь,
      // так как будем полагаться на наш локальный опрос (checkLocalPlayerState),
      // а onStateChange оставляем для обработки окончания видео и других событий.
      if (event.data === YT.PlayerState.ENDED) {
        if (window.isHost && window.autoNext) {
          fetchNextVideo();
        }
      }
    }

    // ==================== ПОЛНОЕ ОПРОСНОЕ ОТСЛЕЖИВАНИЕ PLAY/PAUSE (каждые 500 мс) ====================
    function checkLocalPlayerState() {
      if (player && typeof player.getPlayerState === 'function') {
        const currentState = player.getPlayerState(); // 1 = PLAYING, 2 = PAUSED, и т.д.
        if (previousPlayerState === null) {
          previousPlayerState = currentState;
          return;
        }
        if ((currentState === 1 || currentState === 2) && currentState !== previousPlayerState) {
          console.log(`Local state change: from ${previousPlayerState} to ${currentState}`);
          const action = (currentState === 1) ? 'play' : 'pause';
          socket.emit('playerAction', { roomId, action, timestamp: player.getCurrentTime() });
          previousPlayerState = currentState;
        }
      }
    }
    setInterval(checkLocalPlayerState, 500);

    // ==================== ФУНКЦИЯ ПЕРЕКЛЮЧЕНИЯ НА СЛЕДУЮЩЕ ВИДЕО ====================
    async function fetchNextVideo() {
      const token = getToken();
      try {
        const res = await fetch(`/api/rooms/${roomId}/next`, {
          method: 'POST',
          headers: { 'x-auth-token': token }
        });
        const result = await res.json();
        alert(result.msg);
        if (result.currentVideo && result.currentVideo.url) {
          let videoId = result.currentVideo.url;
          if (videoId.includes('youtube.com')) {
            try {
              const urlObj = new URL(videoId);
              videoId = urlObj.searchParams.get('v') || videoId;
            } catch (e) {
              console.error('Ошибка при разборе URL', e);
            }
          }
          player.loadVideoById(videoId);
          loadQueue();
          socket.emit('videoChanged', { roomId, videoId: result.currentVideo.url });
        } else {
          player.stopVideo();
          socket.emit('videoChanged', { roomId, videoId: null });
        }
      } catch (err) {
        console.error(err);
      }
    }

    // Функция для получения токена из localStorage
    function getToken() {
      return localStorage.getItem('token');
    }

    // ==================== ЗАГРУЗКА ИНФОРМАЦИИ О КОМНАТЕ ====================
    async function loadRoomInfo() {
      try {
        const res = await fetch(`/api/rooms/${roomId}`);
        const room = await res.json();
        document.getElementById('roomInfo').innerHTML = `<h2>${room.name}</h2><p>Хост: ${room.host.username}</p>`;
        window.autoNext = room.settings.autoNext;
        window.allowAllControl = room.settings.allowAllControl;
        if (room.playerStatus && room.playerStatus.currentVideo) {
          let currentVideoId = '';
          if (typeof room.playerStatus.currentVideo === 'object' && room.playerStatus.currentVideo.url) {
            currentVideoId = room.playerStatus.currentVideo.url;
          } else {
            currentVideoId = room.playerStatus.currentVideo;
          }
          if (currentVideoId && currentVideoId.includes('youtube.com')) {
            try {
              const urlObj = new URL(currentVideoId);
              currentVideoId = urlObj.searchParams.get('v') || currentVideoId;
            } catch (e) {
              console.error('Ошибка при разборе URL', e);
            }
          }
          window.currentRoomVideoId = currentVideoId;
          if (player && currentVideoId) {
            player.loadVideoById(currentVideoId);
          }
        }
        const token = getToken();
        if (token) {
          const userRes = await fetch('/api/auth/me', { headers: { 'x-auth-token': token } });
          if (userRes.ok) {
            const user = await userRes.json();
            if (user._id === room.host._id) {
              window.isHost = true;
              const controlsDiv = document.getElementById('userControls');
              controlsDiv.innerHTML = `
                <button id="configRoomBtn">Конфигурация комнаты</button>
                <button id="deleteRoomBtn">Удалить комнату</button>
                <button id="nextVideoBtn">Следующее видео</button>
              `;
              document.getElementById('nextVideoBtn').addEventListener('click', async () => {
                const resNext = await fetch(`/api/rooms/${roomId}/next`, {
                  method: 'POST',
                  headers: { 'x-auth-token': token }
                });
                const resultNext = await resNext.json();
                alert(resultNext.msg);
                loadQueue();
                if (resultNext.currentVideo && resultNext.currentVideo.url) {
                  socket.emit('videoChanged', { roomId, videoId: resultNext.currentVideo.url });
                } else {
                  socket.emit('videoChanged', { roomId, videoId: null });
                }
              });
              document.getElementById('configRoomBtn').addEventListener('click', () => {
                document.getElementById('roomNameInput').value = document.querySelector('#roomInfo h2').textContent;
                document.getElementById('autoNextCheckbox').checked = window.autoNext;
                document.getElementById('allowAllControlCheckbox').checked = window.allowAllControl;
                document.getElementById('configModal').style.display = 'block';
              });
              document.getElementById('closeConfigModal').addEventListener('click', () => {
                document.getElementById('configModal').style.display = 'none';
              });
              window.addEventListener('click', (event) => {
                const configModal = document.getElementById('configModal');
                if (event.target === configModal) {
                  configModal.style.display = 'none';
                }
              });
              document.getElementById('configForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const data = {
                  name: formData.get('name'),
                  autoNext: formData.get('autoNext') === 'on' || formData.get('autoNext') === 'true',
                  allowAllControl: formData.get('allowAllControl') === 'on'
                };
                const token = getToken();
                try {
                  const res = await fetch(`/api/rooms/${roomId}`, {
                    method: 'PUT',
                    headers: {
                      'Content-Type': 'application/json',
                      'x-auth-token': token
                    },
                    body: JSON.stringify(data)
                  });
                  const result = await res.json();
                  alert(result.msg);
                  document.getElementById('configModal').style.display = 'none';
                  loadRoomInfo();
                } catch (err) {
                  console.error(err);
                }
              });
              document.getElementById('deleteRoomBtn').addEventListener('click', async () => {
                const confirmDelete = confirm("Вы уверены, что хотите удалить комнату?");
                if (confirmDelete) {
                  const resDelete = await fetch(`/api/rooms/${roomId}`, {
                    method: 'DELETE',
                    headers: { 'x-auth-token': token }
                  });
                  const resultDelete = await resDelete.json();
                  if (resDelete.ok) {
                    alert(resultDelete.msg);
                    window.location.href = '/';
                  } else {
                    alert(resultDelete.msg);
                  }
                }
              });
            }
          }
        }
        loadQueue();
      } catch (err) {
        console.error(err);
      }
    }

    async function loadQueue() {
      try {
        const res = await fetch(`/api/rooms/${roomId}`);
        const room = await res.json();
        const queueList = document.getElementById('queueList');
        queueList.innerHTML = '';
        if (room.queue && room.queue.length > 0) {
          room.queue.forEach(video => {
            const li = document.createElement('li');
            li.textContent = video.title || video.url;
            if (window.isHost) {
              const delBtn = document.createElement('button');
              delBtn.textContent = 'Удалить';
              delBtn.style.marginLeft = '10px';
              delBtn.addEventListener('click', async () => {
                const token = getToken();
                const confirmDel = confirm('Удалить это видео из очереди?');
                if (confirmDel) {
                  const delRes = await fetch(`/api/rooms/${roomId}/video/${video._id}`, {
                    method: 'DELETE',
                    headers: { 'x-auth-token': token }
                  });
                  const delResult = await delRes.json();
                  alert(delResult.msg);
                  loadQueue();
                }
              });
              li.appendChild(delBtn);
            }
            queueList.appendChild(li);
          });
        } else {
          queueList.innerHTML = '<li>Очередь пуста</li>';
        }
      } catch (err) {
        console.error(err);
      }
    }

    loadRoomInfo();

    // ==================== ОБРАБОТЧИКИ МОДАЛЬНЫХ ОКОН ====================
    const videoModal = document.getElementById('videoModal');
    document.getElementById('proposeVideoBtn').addEventListener('click', () => {
      videoModal.style.display = 'block';
    });
    document.getElementById('closeVideoModal').addEventListener('click', () => {
      videoModal.style.display = 'none';
    });
    window.addEventListener('click', (event) => {
      if (event.target === videoModal) {
        videoModal.style.display = 'none';
      }
    });

    document.getElementById('videoForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const videoUrl = formData.get('videoUrl');
      const token = getToken();
      if (!token) {
        alert('Для предложения видео необходимо войти в систему');
        return;
      }
      const res = await fetch('/api/videos/add', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-auth-token': token
        },
        body: JSON.stringify({
          roomId,
          type: 'youtube',
          url: videoUrl
        })
      });
      const result = await res.json();
      if (result.video) {
        alert('Видео добавлено в очередь');
        videoModal.style.display = 'none';
        loadQueue();
      } else {
        alert(result.msg || 'Ошибка при добавлении видео');
      }
    });

    document.getElementById('backBtn').addEventListener('click', () => {
      window.location.href = '/';
    });
  </script>

</body>
</html>
